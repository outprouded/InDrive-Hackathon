# Документация по использованию Car Integrity Pipeline
 
## Обзор
**Car Integrity Pipeline** — это веб-приложение на основе Streamlit, разработанное для проверки автомобилей. Оно выполняет обнаружение повреждений, классификацию чистоты и оценку степени загрязнения на изображениях автомобилей. Приложение использует модели глубокого обучения (YOLOv8, ViT и VGG) для анализа изображений и предоставления подробных результатов.

Эта документация объясняет, как использовать интерфейс Streamlit, настраивать параметры и интерпретировать результаты.

## Требования
- **Python**: Версия 3.8 или выше.
- **Зависимости**: Установите необходимые пакеты с помощью команды:
  ```bash
  pip install streamlit torch torchvision ultralytics timm numpy pillow
  ```
- **Веса моделей**: Убедитесь, что файлы весов моделей доступны по путям, указанным в словаре `CFG` в файле `app.py`. При необходимости обновите пути.
- **Аппаратное обеспечение**: Рекомендуется использовать GPU с поддержкой CUDA для более быстрого вывода, но поддерживается и CPU.

## Запуск приложения
1. Сохраните код приложения в файл `app.py`.
2. Откройте терминал в директории, содержащей `app.py`.
3. Запустите приложение Streamlit:
   ```bash
   streamlit run app.py
   ```
4. Откройте предоставленный URL (обычно `http://localhost:8501`) в веб-браузере.

## Обзор интерфейса
Интерфейс разделён на:
- **Основная панель**: Отображает заголовок, загрузку изображений/указание пути к папке и результаты анализа.
- **Боковая панель**: Содержит параметры настройки для выбора моделей, порогов и опций отображения.
- **Секция результатов**: Показывает результаты анализа для каждого изображения, включая данные о повреждениях, чистоте, обнаружении и степени загрязнения.

### Основные компоненты
- **Заголовок**: "Car Integrity Analysis" с описанием назначения приложения.
- **Ввод изображений**: Позволяет загружать изображения или указывать путь к папке.
- **Результаты анализа**: Отображает обработанные изображения, результаты классификации и, при необходимости, таблицы вероятностей/детали обнаружения.
- **Боковая панель**: Настройка выбора моделей, порогов и параметров отображения.

## Пошаговое руководство по использованию

### 1. Настройка параметров в боковой панели
Боковая панель организована в раскрывающиеся секции для удобства использования.

#### Выбор моделей
- **Классификатор повреждений**: Выберите между:
  - **YOLOv8s-cls**: Модель YOLOv8 малого размера для классификации повреждений.
  - **ViT (визуальный трансформер)**: Модель Vision Transformer для классификации повреждений.
- **Классификатор степени загрязнения**: Выберите между:
  - **YOLOv8l-cls**: Модель YOLOv8 большого размера для классификации степени загрязнения.
  - **VGG (пользовательская)**: Модель VGG для классификации степени загрязнения.

#### Пороговые значения
Настройте ползунки для установки порогов доверия, которые определяют запуск последующих анализов:
- **Запуск обнаружения, если уверенность в "повреждении" ≥**: По умолчанию 0.50. Более высокие значения требуют большей уверенности для запуска обнаружения повреждений.
- **Запуск классификации степени загрязнения, если уверенность в "грязный" ≥**: По умолчанию 0.50. Более высокие значения требуют большей уверенности для запуска классификации степени загрязнения.
- **Уверенность обнаружения**: По умолчанию 0.25. Устанавливает минимальную уверенность для обнаруженных типов повреждений.
- **IoU обнаружения (NMS)**: По умолчанию 0.70. Контролирует подавление немаксимумов для перекрывающихся обнаружений.

#### Параметры отображения
- **Показать таблицы вероятностей**: Установите флажок, чтобы отобразить распределение вероятностей для классификаций повреждений, чистоты и степени загрязнения.
- **Показать JSON обнаружений**: Установите флажок, чтобы отобразить необработанные данные обнаружения в формате JSON (полезно для отладки или детального анализа).

#### Дополнительная информация
- **Устройство**: Отображает, работает ли приложение на CPU или GPU (например, `cuda:0`).
- **Логика**: Описывает логику работы приложения: всегда классифицировать повреждения и чистоту; запускать обнаружение, если есть повреждения, и классификацию степени загрязнения, если автомобиль грязный.

### 2. Загрузка изображений или указание пути к папке
- **Загрузка изображений**:
  1. В основной панели используйте загрузчик файлов для выбора одного или нескольких изображений (поддерживаемые форматы: JPG, JPEG, PNG, BMP, WebP).
  2. Можно загрузить несколько изображений одновременно.
- **Указание пути к папке**:
  1. Введите действительный путь к папке, содержащей изображения (например, `C:/images/`).
  2. Приложение загрузит все поддерживаемые изображения из указанной папки.
- Если изображения не загружены или путь к папке неверный, появится сообщение с просьбой загрузить изображения или исправить путь.

### 3. Запуск конвейера
После загрузки изображений или указания действительного пути к папке:
1. Приложение загружает выбранные модели (отображается индикатор "Загрузка моделей...").
2. Полоса прогресса показывает статус обработки каждого изображения.
3. Результаты отображаются для каждого изображения в разделе "Результаты анализа".

### 4. Интерпретация результатов
Для каждого изображения результаты отображаются в двух колонках:
- **Левая колонка**: Показывает исходное изображение.
- **Правая колонка**: Отображает результаты классификации, обнаруженные повреждения (при наличии) и, при необходимости, таблицы вероятностей/JSON.

#### Детали вывода
- **Классификация повреждений**: Указывает, является ли автомобиль "повреждённым" или "неповреждённым" с уровнем уверенности (например, `повреждён (0.892)`).
- **Классификация чистоты**: Указывает, является ли автомобиль "чистым" или "грязным" с уровнем уверенности (например, `грязный (0.765)`).
- **Обнаружение (при необходимости)**: Если уверенность в повреждении превышает порог, отображается изображение с рамками, выделяющими обнаруженные типы повреждений (например, вмятины, царапины).
- **Степень загрязнения (при необходимости)**: Если классифицировано как "грязный" и уверенность превышает порог, степень загрязнения классифицируется как "слегка грязный", "грязный" или "очень грязный" с уровнем уверенности.
- **Таблицы вероятностей** (опционально): Показывают распределение вероятностей для каждой классификации (повреждения, чистота, степень загрязнения).
- **JSON обнаружений** (опционально): Отображает необработанные данные обнаружения, включая метки, уверенности и координаты рамок.

#### Визуальная обратная связь
- **Индикаторы загрузки**: Показывают, когда загружаются модели или выполняется вывод.
- **Полоса прогресса**: Отображает прогресс обработки нескольких изображений.
- **Сообщение об успехе**: Подтверждает успешную загрузку моделей и завершение анализа.

### 5. Проверка и корректировка
- Настройте пороговые значения или выбор моделей в боковой панели и повторно загрузите изображения для уточнения результатов.
- Включайте/выключайте параметры отображения, чтобы показать/скрыть таблицы вероятностей или JSON-вывод по необходимости.

## Пример рабочего процесса
1. Откройте приложение в браузере.
2. В боковой панели:
   - Выберите "ViT (визуальный трансформер)" для классификации повреждений.
   - Выберите "VGG (пользовательская)" для классификации степени загрязнения.
   - Установите порог повреждений на 0.60 и порог загрязнения на 0.55.
   - Включите "Показать таблицы вероятностей" и отключите "Показать JSON обнаружений".
3. Загрузите два изображения автомобиля (например, `car1.jpg`, `car2.png`).
4. Дождитесь обработки изображений (полоса прогресса обновляется).
5. Просмотрите результаты:
   - Для `car1.jpg`: "Повреждения: повреждён (0.920) | Чистота: грязный (0.780) → Обнаружение выполнено → Степень загрязнения: очень грязный (0.850)".
   - Изображение обнаружения показывает вмятины и царапины.
   - Таблицы вероятностей показывают распределение уверенности.
6. При необходимости настройте пороги и повторно загрузите изображения.

## Устранение неполадок
- **Ошибки загрузки моделей**: Убедитесь, что пути к файлам весов в `CFG` правильные и доступны.
- **Ошибки чтения изображений**: Проверьте, что загруженные изображения имеют поддерживаемый формат и не повреждены.
- **Проблемы с производительностью**: На CPU вывод может быть медленным. Рассмотрите использование GPU или уменьшение разрешения изображений.
- **Отсутствие результатов**: Убедитесь, что изображения загружены или путь к папке действителен. Проверьте консоль на наличие сообщений об ошибках.

## Примечания
- Приложение использует современный, чистый дизайн с закруглёнными углами, светлым фоном и единообразной типографикой для улучшения удобства использования.
- Раскрывающиеся секции в боковой панели упрощают навигацию по настройкам.
- Логика конвейера обеспечивает эффективную обработку, запуская обнаружение и классификацию степени загрязнения только при превышении порогов.
- Для больших наборов данных обрабатывайте изображения небольшими партиями, чтобы избежать проблем с памятью.

## Поддержка
Для решения проблем или вопросов обратитесь к документации Streamlit или проверьте вывод в консоли для получения подробных сообщений об ошибках. Убедитесь, что все зависимости установлены, а веса моделей правильно настроены.

## Модели и Данные
[Модели и данные](https://drive.google.com/drive/folders/1NkTYeUsdO1JQlzEhrR2uLWF6Q1MmSdb9?usp=sharing)
